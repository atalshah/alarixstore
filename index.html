<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarix | Markaz Style Marketplace</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root { --primary: #00b894; --bg-gray: #f7f8fa; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fff; color: #1d1d1f; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .markaz-bg { background-color: var(--primary); }
        .markaz-green { color: var(--primary); }
        
        /* Overlays & Modals */
        .overlay { position: fixed; inset: 0; background: white; z-index: 200; display: none; flex-direction: column; }
        .overlay.active { display: flex; animation: slideIn 0.3s ease-out; }
        
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* UI Elements */
        .cat-sidebar { width: 90px; height: 100%; background: #f1f3f6; border-right: 1px solid #eee; overflow-y: auto; }
        .cat-item { padding: 15px 5px; font-size: 10px; text-align: center; font-weight: 700; color: #666; cursor: pointer; }
        .cat-item.active { background: white; color: var(--primary); border-left: 4px solid var(--primary); }
        
        .product-card { background: white; border: 1px solid #f0f0f0; border-radius: 12px; overflow: hidden; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        
        #splash { position: fixed; inset: 0; background: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 16px; border-radius: 12px; font-weight: 800; font-size: 16px; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        .hidden-view { display: none !important; }
        input, textarea, select { border: 1px solid #e5e7eb; padding: 12px; border-radius: 10px; outline: none; width: 100%; background: #f9fafb; }
        input:focus { border-color: var(--primary); }
    </style>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="w-20 h-20 markaz-bg rounded-[24px] flex items-center justify-center text-white text-4xl font-black shadow-lg">A</div>
        <h1 class="mt-4 text-2xl font-black tracking-tighter">ALARIX</h1>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-[2500] bg-white hidden p-8 flex flex-col justify-center">
        <h2 class="text-3xl font-black mb-2">Welcome</h2>
        <p class="text-gray-400 mb-8">Enter details to start business.</p>
        <div class="space-y-4">
            <input type="text" id="reg-name" placeholder="Full Name">
            <input type="tel" id="reg-wa" placeholder="WhatsApp Number">
            <input type="text" id="reg-city" placeholder="City">
            <button onclick="handleAuth()" class="btn-primary mt-4 shadow-xl">Start Selling</button>
        </div>
    </div>

    <!-- TOP HEADER -->
    <header class="fixed top-0 w-full bg-white z-[150] px-5 h-16 flex items-center justify-between border-b">
        <div class="flex items-center gap-2" onclick="switchView('home')">
            <div class="markaz-green"><i data-lucide="zap" class="fill-current w-6 h-6"></i></div>
            <h1 class="text-xl font-bold tracking-tighter">ALARIX</h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="switchView('favorites')" class="relative"><i data-lucide="heart" class="w-6 h-6 text-gray-400"></i><span id="fav-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] px-1 rounded-full">0</span></button>
            <button onclick="switchView('cart')" class="relative"><i data-lucide="shopping-bag" class="w-6 h-6 text-gray-400"></i><span id="cart-count" class="absolute -top-1 -right-1 markaz-bg text-white text-[8px] px-1 rounded-full">0</span></button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="mt-16 pb-20">
        <!-- Home -->
        <section id="view-home" class="px-4 py-4">
            <div class="relative mb-4">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" placeholder="Search products..." class="pl-10" oninput="searchProduct(this.value)">
            </div>
            <div id="product-grid" class="grid grid-cols-2 gap-3"></div>
        </section>

        <!-- Category -->
        <section id="view-category" class="hidden-view flex h-[calc(100vh-140px)]">
            <div class="cat-sidebar" id="cat-list"></div>
            <div class="flex-1 p-4 overflow-y-auto" id="sub-cat-grid"></div>
        </section>

        <!-- Cart -->
        <section id="view-cart" class="hidden-view px-4 pt-4">
            <h2 class="text-xl font-bold mb-4">Shopping Cart</h2>
            <div id="cart-items" class="space-y-3"></div>
            <div id="cart-empty" class="text-center py-20 text-gray-400 font-medium">Your cart is empty.</div>
        </section>

        <!-- Profile -->
        <section id="view-profile" class="hidden-view p-6">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center text-2xl">ðŸ‘¤</div>
                <div><h2 id="prof-name" class="font-bold text-lg">Name</h2><p id="prof-city" class="text-xs text-gray-400 uppercase font-bold tracking-widest"></p></div>
            </div>
            <div id="seller-area" class="space-y-3"></div>
            <button onclick="switchView('purchases')" class="w-full flex justify-between items-center p-4 bg-gray-50 rounded-xl mt-4">
                <span class="font-bold">My Orders</span><i data-lucide="chevron-right"></i>
            </button>
        </section>

        <!-- Purchases -->
        <section id="view-purchases" class="hidden-view p-4">
            <div class="flex items-center gap-3 mb-4"><button onclick="switchView('profile')"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold">Orders</h2></div>
            <div id="purchases-list" class="space-y-3"></div>
        </section>

        <!-- Seller Product Posting -->
        <section id="view-post" class="hidden-view p-6">
            <div class="flex items-center gap-3 mb-6"><button onclick="switchView('profile')"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold">Post Product</h2></div>
            <div class="space-y-4">
                <input type="text" id="p-name" placeholder="Product Name">
                <input type="number" id="p-price" placeholder="Price (Wholesale)">
                <select id="p-cat">
                    <option>Mens Fashion</option><option>Ladies Fashion</option><option>Electronics</option><option>Home Decor</option>
                </select>
                <input type="url" id="p-img" placeholder="Image URL (ImgBB)">
                <textarea id="p-desc" placeholder="Product Description" rows="4"></textarea>
                <button onclick="publishProduct()" class="btn-primary">Post Live</button>
            </div>
        </section>
    </main>

    <!-- PRODUCT DETAIL OVERLAY -->
    <div id="overlay-detail" class="overlay">
        <header class="h-16 flex items-center justify-between px-4 border-b bg-white">
            <button onclick="closeOverlay('overlay-detail')"><i data-lucide="arrow-left"></i></button>
            <div class="flex gap-4">
                <button onclick="toggleFav()"><i id="det-fav" data-lucide="heart" class="w-6 h-6"></i></button>
                <button onclick="shareLink()"><i data-lucide="share-2" class="w-6 h-6"></i></button>
            </div>
        </header>
        <div class="overflow-y-auto flex-1 pb-24">
            <img id="det-img" src="" class="w-full aspect-square object-contain bg-white">
            <div class="p-5">
                <h2 id="det-price" class="text-2xl font-black markaz-green mb-1"></h2>
                <h1 id="det-title" class="text-lg font-bold mb-4"></h1>
                <div class="bg-orange-50 p-4 rounded-xl mb-4 border border-orange-100 flex justify-between">
                    <span class="text-xs font-bold text-orange-700">Standard Shipping: Rs. 125</span>
                    <i data-lucide="truck" class="w-4 h-4 text-orange-400"></i>
                </div>
                <p id="det-desc" class="text-sm text-gray-500 leading-relaxed border-t pt-4"></p>
            </div>
        </div>
        <div class="fixed bottom-0 w-full p-4 bg-white border-t flex gap-3 h-20 items-center">
            <button onclick="addToCart()" class="flex-1 border-2 border-emerald-500 text-emerald-500 font-bold py-3 rounded-xl">Add to Cart</button>
            <button onclick="openOrderFlow()" class="flex-1 markaz-bg text-white font-bold py-3 rounded-xl">Order Now</button>
        </div>
    </div>

    <!-- ORDER FLOW OVERLAY (MARKAZ STYLE) -->
    <div id="overlay-order" class="overlay p-6">
        <div class="flex items-center gap-3 mb-6"><button onclick="closeOverlay('overlay-order')"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold">Order Details</h2></div>
        
        <div id="order-step-1" class="space-y-6">
            <div class="bg-gray-50 p-5 rounded-2xl">
                <p class="text-xs text-gray-400 font-bold mb-2">Wholesale Price: <span id="summ-wholesale">0</span></p>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] font-black uppercase text-gray-500">Your Profit</label>
                        <input type="number" id="user-profit" placeholder="0" oninput="calculateTotal()" class="text-xl font-bold">
                    </div>
                    <div class="text-right">
                        <label class="text-[10px] font-black uppercase text-gray-500">Total Bill</label>
                        <p id="summ-total" class="text-xl font-black markaz-green">Rs. 0</p>
                    </div>
                </div>
            </div>
            <button onclick="nextOrderStep()" class="btn-primary">Next: Customer Address</button>
        </div>

        <div id="order-step-2" class="hidden-view space-y-4">
            <input type="text" id="cust-name" placeholder="Customer Name">
            <input type="tel" id="cust-phone" placeholder="Phone Number">
            <input type="text" id="cust-city" placeholder="City">
            <textarea id="cust-address" placeholder="House No, Street Name, Famous Landmark..." rows="3"></textarea>
            <button onclick="confirmOrder()" class="btn-primary shadow-xl">Confirm Order</button>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <div onclick="switchView('home')" class="flex flex-col items-center markaz-green" id="nav-home"><i data-lucide="home"></i><span class="text-[9px] font-bold">Home</span></div>
        <div onclick="switchView('category')" class="flex flex-col items-center text-gray-400" id="nav-category"><i data-lucide="grid"></i><span class="text-[9px] font-bold">Category</span></div>
        <div onclick="switchView('profile')" class="flex flex-col items-center text-gray-400" id="nav-profile"><i data-lucide="user"></i><span class="text-[9px] font-bold">Profile</span></div>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3D_1IRdpPB_2rmF5rtGqvJ1EXFNF2zxc",
            authDomain: "alarix-61e90.firebaseapp.com",
            databaseURL: "https://alarix-61e90-default-rtdb.firebaseio.com",
            projectId: "alarix-61e90",
            storageBucket: "alarix-61e90.firebasestorage.app",
            messagingSenderId: "747193234958",
            appId: "1:747193234958:web:c69501009d5950b63d6e5f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let products = [], cart = [], favorites = [], userData = null, storeData = null;
        let selectedProduct = null;
        let shippingFee = 125;
        let uid = localStorage.getItem('al_uid') || 'U' + Date.now();
        localStorage.setItem('al_uid', uid);

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.display = 'none';
                initApp();
            }, 2000);
        };

        function initApp() {
            userData = JSON.parse(localStorage.getItem('al_user_data'));
            if(!userData) document.getElementById('auth-screen').classList.remove('hidden');
            else startSync();
        }

        function handleAuth() {
            const n = document.getElementById('reg-name').value, w = document.getElementById('reg-wa').value, c = document.getElementById('reg-city').value;
            if(!n || !w || !c) return alert("All fields are required");
            const data = { name: n, whatsapp: w, city: c, uid: uid };
            localStorage.setItem('al_user_data', JSON.stringify(data));
            db.ref(`users/${uid}/profile`).set(data).then(() => location.reload());
        }

        function startSync() {
            db.ref('products').on('value', s => {
                products = s.val() ? Object.entries(s.val()).map(([id,v])=>({id,...v})) : [];
                renderHome();
                renderCategories();
            });
            db.ref(`users/${uid}`).on('value', s => {
                const d = s.val() || {};
                cart = d.cart ? Object.entries(d.cart).map(([key,v])=>({cartId:key,...v})) : [];
                favorites = d.favs ? Object.values(d.favs) : [];
                storeData = d.store || null;
                updateUI();
            });
            db.ref('orders').on('value', s => {
                const oData = s.val() ? Object.values(s.val()) : [];
                renderPurchases(oData.filter(o => o.buyerId === uid));
            });
        }

        // VIEW CONTROLS
        function switchView(v) {
            ['home', 'category', 'profile', 'purchases', 'post', 'cart', 'favorites'].forEach(id => {
                const el = document.getElementById('view-'+id);
                if(el) el.classList.add('hidden-view');
            });
            document.getElementById('view-'+v).classList.remove('hidden-view');
            
            // Navbar Icon Colors
            document.querySelectorAll('.bottom-nav div').forEach(el => el.classList.replace('markaz-green', 'text-gray-400'));
            const activeNav = (v === 'category' || v === 'profile') ? v : 'home';
            document.getElementById('nav-'+activeNav).classList.replace('text-gray-400', 'markaz-green');
            
            if(v === 'cart') renderCart();
            if(v === 'favorites') renderFavorites();
            lucide.createIcons();
            window.scrollTo(0,0);
        }

        function openOverlay(id) { document.getElementById(id).classList.add('active'); lucide.createIcons(); }
        function closeOverlay(id) { document.getElementById(id).classList.remove('active'); }

        // PRODUCT ACTIONS
        function renderHome(list = products) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = list.map(p => `
                <div class="product-card" onclick="openDetail('${p.id}')">
                    <div class="h-36 p-2 flex items-center justify-center bg-gray-50"><img src="${p.image}" class="max-h-full object-contain"></div>
                    <div class="p-3">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">${p.category}</p>
                        <h3 class="text-xs font-bold truncate">${p.name}</h3>
                        <p class="text-sm font-black markaz-green mt-1">Rs. ${p.price}</p>
                    </div>
                </div>`).join('');
        }

        function openDetail(id) {
            selectedProduct = products.find(p => p.id === id);
            document.getElementById('det-img').src = selectedProduct.image;
            document.getElementById('det-title').innerText = selectedProduct.name;
            document.getElementById('det-price').innerText = 'Rs. ' + selectedProduct.price;
            document.getElementById('det-desc').innerText = selectedProduct.desc;
            
            const isFav = favorites.some(f => f.id === id);
            const favIcon = document.getElementById('det-fav');
            favIcon.style.fill = isFav ? '#ef4444' : 'none';
            favIcon.style.color = isFav ? '#ef4444' : '#9ca3af';
            
            openOverlay('overlay-detail');
        }

        // ORDER FLOW (MARKAZ STYLE)
        function openOrderFlow() {
            document.getElementById('summ-wholesale').innerText = 'Rs. ' + selectedProduct.price;
            document.getElementById('user-profit').value = '';
            document.getElementById('summ-total').innerText = 'Rs. ' + (parseInt(selectedProduct.price) + shippingFee);
            
            document.getElementById('order-step-1').classList.remove('hidden-view');
            document.getElementById('order-step-2').classList.add('hidden-view');
            openOverlay('overlay-order');
        }

        function calculateTotal() {
            const profit = parseInt(document.getElementById('user-profit').value) || 0;
            const total = parseInt(selectedProduct.price) + shippingFee + profit;
            document.getElementById('summ-total').innerText = 'Rs. ' + total;
        }

        function nextOrderStep() {
            document.getElementById('order-step-1').classList.add('hidden-view');
            document.getElementById('order-step-2').classList.remove('hidden-view');
        }

        function confirmOrder() {
            const name = document.getElementById('cust-name').value, phone = document.getElementById('cust-phone').value, addr = document.getElementById('cust-address').value;
            if(!name || !phone || !addr) return alert("Complete the address details");
            
            const profit = parseInt(document.getElementById('user-profit').value) || 0;
            const totalBill = parseInt(selectedProduct.price) + shippingFee + profit;

            const order = {
                buyerId: uid,
                productName: selectedProduct.name,
                wholesalePrice: selectedProduct.price,
                profit: profit,
                totalBill: totalBill,
                customerName: name,
                customerPhone: phone,
                address: addr,
                status: 'Pending',
                timestamp: Date.now()
            };

            db.ref('orders').push(order).then(() => {
                alert("Order Placed Successfully!");
                closeOverlay('overlay-order');
                closeOverlay('overlay-detail');
                switchView('purchases');
            });
        }

        // CART & FAVS
        function addToCart() {
            db.ref(`users/${uid}/cart`).push(selectedProduct).then(() => alert("Added to Bag"));
        }

        function toggleFav() {
            const exists = favorites.find(f => f.id === selectedProduct.id);
            if(exists) db.ref(`users/${uid}/favs`).orderByChild('id').equalTo(selectedProduct.id).once('value', s => s.forEach(c => c.ref.remove()));
            else db.ref(`users/${uid}/favs`).push(selectedProduct);
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            if(cart.length === 0) {
                container.innerHTML = '';
                document.getElementById('cart-empty').classList.remove('hidden-view');
                return;
            }
            document.getElementById('cart-empty').classList.add('hidden-view');
            container.innerHTML = cart.map(item => `
                <div class="flex gap-4 bg-gray-50 p-3 rounded-xl">
                    <img src="${item.image}" class="w-16 h-16 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="text-sm font-bold">${item.name}</h4>
                        <p class="text-xs markaz-green font-bold">Rs. ${item.price}</p>
                    </div>
                    <button onclick="removeFromCart('${item.cartId}')" class="text-red-400"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>`).join('');
            lucide.createIcons();
        }

        function removeFromCart(id) { db.ref(`users/${uid}/cart/${id}`).remove(); }

        // SELLER
        function updateUI() {
            document.getElementById('prof-name').innerText = userData.name;
            document.getElementById('prof-city').innerText = userData.city;
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('fav-count').innerText = favorites.length;
            
            const sellerArea = document.getElementById('seller-area');
            if(storeData) {
                sellerArea.innerHTML = `
                <div class="bg-black text-white p-5 rounded-2xl">
                    <p class="text-[10px] font-bold opacity-60 uppercase">My Shop</p>
                    <h3 class="text-xl font-black">${storeData.storeName}</h3>
                    <div class="flex gap-2 mt-4">
                        <button onclick="switchView('post')" class="flex-1 bg-white text-black py-2 rounded-lg font-bold text-xs">Post Product</button>
                        <button class="flex-1 border border-white/30 py-2 rounded-lg font-bold text-xs">Settings</button>
                    </div>
                </div>`;
            } else {
                sellerArea.innerHTML = `<button onclick="setupStore()" class="btn-primary">Open Your Business Store</button>`;
            }
        }

        function setupStore() {
            const sName = prompt("Enter Shop Name:");
            if(sName) db.ref(`users/${uid}/store`).set({ storeName: sName });
        }

        function publishProduct() {
            const n = document.getElementById('p-name').value, p = document.getElementById('p-price').value, c = document.getElementById('p-cat').value, i = document.getElementById('p-img').value, d = document.getElementById('p-desc').value;
            if(!n || !p || !i) return alert("Fill all fields");
            
            const newRef = db.ref('products').push();
            newRef.set({ id: newRef.key, name: n, price: p, category: c, image: i, desc: d, sellerId: uid, timestamp: Date.now() })
            .then(() => {
                alert("Product Live!");
                switchView('home');
            });
        }

        function renderPurchases(list) {
            document.getElementById('purchases-list').innerHTML = list.map(o => `
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold">${o.productName}</span><span class="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-1 rounded-full font-bold">${o.status}</span></div>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>Total Bill: Rs. ${o.totalBill}</span><span>Profit: Rs. ${o.profit}</span></div>
                </div>`).join('');
        }

        function renderCategories() {
            const cats = ['All', ...new Set(products.map(p => p.category))];
            document.getElementById('cat-list').innerHTML = cats.map(c => `<div onclick="filterCat('${c}', this)" class="cat-item ${c === 'All' ? 'active' : ''}">${c}</div>`).join('');
            filterCat('All', document.querySelector('.cat-item'));
        }

        function filterCat(c, el) {
            document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            const filtered = c === 'All' ? products : products.filter(p => p.category === c);
            const grid = document.getElementById('sub-cat-grid');
            grid.innerHTML = `<div class="grid grid-cols-2 gap-3">${filtered.map(p => `
                <div class="product-card" onclick="openDetail('${p.id}')">
                    <img src="${p.image}" class="h-28 w-full object-contain p-2">
                    <div class="p-2"><h4 class="text-[10px] font-bold truncate">${p.name}</h4><p class="text-xs font-black markaz-green">Rs. ${p.price}</p></div>
                </div>`).join('')}</div>`;
        }

        function searchProduct(q) {
            const filtered = products.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
            renderHome(filtered);
        }

        lucide.createIcons();
    </script>
</body>
</html>
